<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Photo Capture Study</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f9fafb;
      color: #222;
      margin: 0;
      padding: 1.5rem;
    }
    main {
      max-width: 600px;
      margin: auto;
      background: #fff;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    img {
      width: 100%;
      border-radius: 8px;
      margin-top: 1rem;
    }
    button {
      margin-top: 1rem;
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      border: none;
      border-radius: 8px;
      background: #2563eb;
      color: white;
      cursor: pointer;
    }
    button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
<main>
    <div id="consentSection">
  <h2>Willkommen!</h2>
    <p>
        In dieser kurzen Umfrage der Universität Bamberg werden Sie gebeten, einen <b>Kassenzettel</b> zu fotografieren, der <b>nicht älter als 4 Wochen</b> ist und <b>mindestens 8 Lebensmittel</b> enthält. 
    </p>
    <p>
        Kassenzettel lassen keinen Rückschluss auf ihre Person oder ihre Zahlungsdaten zu. Wir werten ausschließlich die gekauften Produkte aus, um mehr über das Einkaufsverhalten in Deutschland zu lernen. Durch die Teilnahme setzen Sie sich keinen Risiken aus. Für Rückfragen können Sie sich jederzeit an philipp.sprengholz@uni-bamberg.de wenden.
    </p>
   <button id="consentBtn">Ich möchte an der Studie teilnehmen und stimme der Übertragung meines Kassenzettels für wissenschaftliche Zwecke zu.</button>
    
    </div>

  <div id="photoSection" style="display:none;">
    <h2>Ihr Kassenzettel</h2>
    <p>Sie können Ihren Kassenzettel fotografieren oder aus der Fotogallerie hochladen. Wenn Sie einen Kassenzettel aus einer Supermarkt-App (z.B. LIDL Plus, REWE App) hochladen möchten, müssen sie diesen zunächst aus der App in die Fotogallerie exportieren.</p>
    <p>Wichtig: Ihr Kassenzettel sollte <b>nicht älter als 4 Wochen</b> sein und <b>mindestens 8 Lebensmittel</b> enthalten. <b>Alle Produkte und die Gesamtsumme müssen sichtbar sein</b>, übrige Details können abgeschnitten sein.</p>
    <input type="file" id="photoInput" accept="image/*" style="display:none;">
    <button id="openCameraBtn">Kassenzettel aufnehmen</button>
    <img id="previewImg" style="display:none;" alt="Photo preview">
    <p id="submitTxt" style="display:none;">Zufrieden mit der Aufnahme? Dann können Sie diese unten abschicken. Alternativ können Sie den Kassenzettel oben neu aufnehmen.</p>
    <button id="submitBtn" style="display:none;">Kassenzettel abschicken</button>
    <p id="uploadStatus"></p>
  </div>

  <div id="successSection" style="display:none;">
    <h2>Danke!</h2>
    <p>Ihr Kassenzettel wurde erfolgreich übertragen.</p>
    <p>Wir werden Sie in einigen Wochen über Prolific zu einer längeren Studie einladen, in der wir Ihnen weitere Fragen zu Ihrem Einkaufsverhalten möchten. Wir würden uns freuen, wenn Sie ebenfalls daran teilnehmen.</p>
    <button id="returnButton" onclick="location.href = 'https://google.com';">Zurück zu Prolific</button>
  </divY>
</main>

<script>
  /**********************************************
   * URL Parameters
   **********************************************/
  const urlParams = new URLSearchParams(window.location.search);
  const p1 = urlParams.get("p1") || "NA";
  const p2 = urlParams.get("p2") || "NA";
  const p3 = urlParams.get("p3") || "NA";
  const filePrefix = `${p1}_${p2}_${p3}_${Date.now()}`;

  /**********************************************
   * Elements
   **********************************************/
  const consentSection = document.getElementById("consentSection");
  const consentButton = document.getElementById("consentBtn");
  const consentCheckbox = document.getElementById("consentCheckbox");
  const photoSection = document.getElementById("photoSection");
  const photoInput = document.getElementById("photoInput");
  const openCameraBtn = document.getElementById("openCameraBtn");
  const previewImg = document.getElementById("previewImg");
  const submitTxt = document.getElementById("submitTxt");
  const submitBtn = document.getElementById("submitBtn");
  const uploadStatus = document.getElementById("uploadStatus");
  const successSection = document.getElementById("successSection");

  let photoBlob = null;

  /**********************************************
   * Consent → Show photo section
   **********************************************/
  consentButton.addEventListener("click", () => {
    
      consentSection.style.display = "none";
      photoSection.style.display = "block";
  

  
  });

  /**********************************************
   * Trigger camera/gallery
   **********************************************/
  openCameraBtn.addEventListener("click", () => {
    photoInput.click();
  });

  /**********************************************
   * Handle selected/taken photo
   **********************************************/
  photoInput.addEventListener("change", async (event) => {
    const file = event.target.files[0];
    if (!file) return;

    // Downscale large images
    const resizedBlob = await downscaleImage(file, 1920);
    photoBlob = resizedBlob;

    previewImg.src = URL.createObjectURL(resizedBlob);
    previewImg.style.display = "block";
    submitTxt.style.display = "inline-block";
    submitBtn.style.display = "inline-block";
  });

  /**********************************************
   * Uploadcare upload
   **********************************************/
  submitBtn.addEventListener("click", async () => {
    if (!photoBlob) {
      alert("Bitte erst Kassenzettel auswählen.");
      return;
    }

    uploadStatus.textContent = "Kassenzettel wird hochgeladen...";
    submitBtn.disabled = true;

    try {
      const formData = new FormData();
      formData.append("UPLOADCARE_PUB_KEY", "351444e3f267f43e60a9");
      formData.append("UPLOADCARE_STORE", "1");
      formData.append("file", photoBlob, `${filePrefix}.jpg`);

      const response = await fetch("https://upload.uploadcare.com/base/", {
        method: "POST",
        body: formData,
      });
      const result = await response.json();
      const photoUrl = `https://ucarecdn.com/${result.file}/`;

      uploadStatus.textContent = "✅ Kassenzettel erfolgreich übertragen";

      successSection.style.display = "block";
      photoSection.style.display = "none";
    } catch (error) {
      console.error("Upload failed:", error);
      uploadStatus.textContent = "❌ Kassenzettel konnte nicht übertragen werden, bitte versuchen Sie es noch einmal";
      submitBtn.disabled = false;
    }
  });

  /**********************************************
   * Helper: Downscale large image
   **********************************************/
  async function downscaleImage(file, maxWidth) {
    const img = new Image();
    const dataUrl = await new Promise(resolve => {
      const reader = new FileReader();
      reader.onload = e => resolve(e.target.result);
      reader.readAsDataURL(file);
    });
    img.src = dataUrl;
    await img.decode();

    let { width, height } = img;
    if (width > maxWidth) {
      height = Math.round(height * (maxWidth / width));
      width = maxWidth;
    }

    const canvas = document.createElement("canvas");
    canvas.width = width;
    canvas.height = height;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0, width, height);

    return new Promise(resolve => {
      canvas.toBlob(blob => resolve(blob), "image/jpeg", 0.9);
    });
  }
</script>
</body>
</html>
